---
title: "Normal Outcome"
author: "Thevaa Chandereng, Donald Musgrove, Tarek Haddad, Graeme Hickey, Timothy Hanson, Theodore Lystig"
header-includes:
   - \usepackage{amsmath}
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{bayesCT:normal}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
  \usepackage[utf8]{inputenc}
---


```{r setup, echo=FALSE, results="hide"}
knitr::opts_chunk$set(comment = "#>", collapse = TRUE)
set.seed(28999)
```

```{r, message = FALSE, echo = FALSE}
library(bayesCT)
```

# Introduction

The purpose of this vignette is to introduce how to simulate and analyze an adaptive bayesian clinical trial for normal outcomes. 
The simulation section compromise of the design of the trial itself which provides a type I error rate and power at each interim look. 
We use the normal-normal conjugate for the estimation of posterior probabilities. 
The historical data is used as an informative prior and we use `bayesDP` as an engine to incorporate the historical data. 


# Estimation of Treatment Difference
Let $\bar{y}$, $s$, and $N$ denote the sample mean, sample standard deviation, and sample size, respectively. 
Then, the posterior distribution of the mean under vague (flat) priors is

$$ \begin{array}{rcl}
\tilde{\sigma}^2\mid\bar{y},s,N & \sim & InverseGamma\left(\frac{N-1}{2},\,\frac{N-1}{2}s^2 \right),\\
\\
\tilde{\mu}\mid\bar{y},N,\tilde{\sigma}^2 & \sim & \mathcal{N}ormal\left(\bar{y},\, \frac{1}{N}\tilde{\sigma}^2  \right).
\end{array}$$

When historical data is present, let $\bar{y}_0$, $s_0$, and $N_0$ denote the sample mean, sample standard deviation, and sample size of the historical data, respectively.
The posterior distribution of the mean for the historical data is 
$$ \begin{array}{rcl}
\sigma^2_0\mid\bar{y_0},s_0,N_0 & \sim & InverseGamma\left(\frac{N_0-1}{2},\,\frac{N_0-1}{2}s_0^2 \right),\\
\\
\mu_0 \mid \bar{y}_0, N_0, \sigma^2_0 &  \sim  & \mathcal{N}ormal\left(\bar{y}_0,\, \frac{1}{N_0}\sigma^2_0  \right).
\end{array}$$
The weight of the historical data included in the study design and analysis is denoted by $\hat\alpha$. 
For more details on computation of $\hat{\alpha}$, please refer to the vignette of binomial counts avaialable at [https://cran.r-project.org/web/packages/bayesDP/vignettes/bdpnormal-vignette.html](https://cran.r-project.org/web/packages/bayesDP/vignettes/bdpnormal-vignette.html).
The posterior distribution of the mean outcome with historical data incorporated under vague (flat) priors is 
$$\tilde{\mu} \sim \mathcal{N}ormal\left( \frac{\sigma^2_0N\bar{y} + \tilde{\sigma}^2N_0\bar{y}_0\hat{\alpha}}{N\sigma^2_0 + \tilde{\sigma}^2N_0\hat{\alpha}},\,\frac{\tilde{\sigma}^2\sigma^2_0}{N\sigma^2_0 + \tilde{\sigma}^2N_0\hat{\alpha}}      \right).$$

Even though there is a closed-form solution for difference in normal distribution ( $\mathcal{N}ormal(\mu_1, \sigma_1^2)$ - $\mathcal{N}ormal(\mu_2, \sigma_2^2)$), we use Monte Carlo estimation of the posteriors of treatment and control group to compute the effect of treatment difference. 

The estimation of mean of treatment difference $\tilde{\mu_T} - \tilde{\mu_C}$, where $\mu_T$ is the posterior mean outcome in the treatment group and $\mu_C$ is the posterior mean outcome in the control group.




# Wrapper Function for Design and Analysis

Unlike traditional R function, the R package depends on pipe inputs with different wrapper functions. All the wrapper functions are illustrated below with details on the arguments for the simulation and analysis. 

**normal_outcome**: The normal outcome is a wrapper function for the simulation. The normal outcome has four input (**mu_treatment**, **mu_control**, **sd_treatment**, **sd_control**).

- **mu_treatment** and **sd_treatment** are required inputs where the mean and standard deviation outcome for a single-arm or double-arm trials are specified for the treatment arm, where $ sd_{treatment} > 0$. 

- **mu_control** and **sd_control** are set to NULL as default for single-arm trials. However, for two-arm trials **mu_control** and **sd_control** inputs specify the mean and standard deviation outcome for the control arm, where $sd_{control} > 0$. 


**study_details**: The study details is a wrapper function for the simulation. The **study_details** function takes four input (**total_sample_size**, **study_period**, **interim_look** and **prop_loss_to_followup**). 

- **total_sample_size** input determines the number of sample size required to run the simulation. 

- **study_period** input determines the length of the study. Since interim look at x is done when the x^{th} patient is enrolled, the length of study is important for imputation purpose.  

- **interim_look** function allows a vector of numeric value, where the trials are stopped to check for early success or futility. For more details on the early stopping for futility or success, please look at the [https://thevaachandereng.github.io/bayesCT/articles/bayesCT.html#early-stopping-for-futility-or-success](https://thevaachandereng.github.io/bayesCT/articles/bayesCT.html#early-stopping-for-futility-or-success). The interim_look values need to be smaller than the sample_size value. 

- Loss to follow up is not peculiar in a clinical trial setting, the **prop_loss_to_followup** input allows to set the proportion of loss to follow up. The default value is set to 0.10. The **prop_loss_to_followup** needs to be between 0 and 1.  


**enrollment_rate**: The enrollment rate is a wrapper function for the simulation. The **enrollment_rate** function takes two input (**lambda**, **time**) unlike the **enrollment** function. 

- **lambda** input is similar to **param** input in the **enrollment** function where it takes different lambda values for different poison rates (the default is set to 0.3, i.e. 0.3 patients per recruited per day). 

- **time** input works similarly to the **time** input in the **enrollment** function where **time** input determines the cutoff rate for different poison rate (default set to NULL). For more details, please look at the recruitment section on the [https://thevaachandereng.github.io/bayesCT/articles/bayesCT.html#recruitment](https://thevaachandereng.github.io/bayesCT/articles/bayesCT.html#recruitment).  


**hypothesis**: The hypothesis is a wrapper function for both simulation and analysis. The **hypothesis** wrapper takes five different inputs (**delta**, **prob_accept_ha**, **futility_prob**, **expected_success_prob** and **alternative**). 

- The **delta** input determines the threshold difference for treatment and control group or the threshold for single-arm trial (the default is set to 0). For non-inferiority trial, the difference needs to be < 0.  

- The input **prob_accept_ha** controls the probability of accepting the alternative hypothesis. The default is set to 0.95. 

- **futility_prob** input controls the futility rate $\omega$ in the [https://thevaachandereng.github.io/bayesCT/articles/bayesCT.html#futility](https://thevaachandereng.github.io/bayesCT/articles/bayesCT.html#futility). The default is set to 0.10. To prevent the trial for stopping for futility, set the **futility_prob** to 0. 

- **expected_success_prob** input controls the early success rate $\Delta$ in the [bayesCT main vignette](https://thevaachandereng.github.io/bayesCT/articles/bayesCT.html). The default is set to 0.90. To prevent the trial for stopping for early success, set the **expected_success_prob** to 1. For more details on the criteria of early stopping for success or futility, please see the [https://thevaachandereng.github.io/bayesCT/articles/bayesCT.html#success](https://thevaachandereng.github.io/bayesCT/articles/bayesCT.html#success). The -

- **alternative** input takes a character string specifying the alternative hypothesis, must be one of "greater" $mu_{treatment} > mu_{control}$ (default), "less" $mu_{treatment} < mu_{control}$ or "two-sided" $mu_{treatment} \neq mu_{control}$.


**randomize**: The randomize is a wrapper function for the simulation. The **randomize**
 function takes two input (**block_size** and **randomization_ratio**). 
 
 - **block_size** input controls the size of each block to randomize. 
 
- **randomization_ratio** is a vector of length 2 which determine the ratio for control to treatment. For more details, please look at the randomization section on the [https://thevaachandereng.github.io/bayesCT/articles/bayesCT.html#randomization-scheme](https://thevaachandereng.github.io/bayesCT/articles/bayesCT.html#randomization-scheme).  


**impute**: The impute is a wrapper function for simulation and analysis. The **impute** function takes two input (**no_of_impute**, **number_mcmc**). 

- **no_of_impute** determines the number of imputation done for loss to follow-up to stop for early success and number of imputation done for loss to follow-up and patients not enrolled (only in simulation scenario) for loss to follow-up for futility. The default is set to 10 to generate the vignette quickly. However, the general rule of thumb for implementation of adaptive trials would be to set **no_of_impute** to 10,000. 

- A Monte Carlo estimation approach is used to estimate the posterior probability, requiring several samples from the posterior distributions. The **number_mcmc** controls the number of Monte Carlo estimation with default set to 10000.  


**historical_normal**: The historical normal wrapper function allows incorporation of historical data using discount function in the analysis and simulation. This wrapper is only used when historical data is incorporated in the analysis or simulation. For more details on the method and computation, please look at the [bayesDP normal vignette](https://cran.r-project.org/web/packages/bayesDP/vignettes/bdpnormal-vignette.html). 
Historical binomial takes 9 inputs.

- **mu0_treatment**: Mean of the historical treatment group.

- **sd0_treatment**: The standard deviation of the historical treatment group.

- **N0_treatment**: The sample size for the historical treatment group.

- **mu0_control**: Mean of the historical control group.

- **sd0_control**: The standard deviation of the historical control group.

- **N0_control**: The sample size for the historical control group.

- **discount_function**: Specify the discount function to use. Currently supports weibull, scaledweibull, and identity. The discount function scaledweibull scales the output of the Weibull CDF to have a max value of 1. The identity discount function uses the posterior probability directly as the discount weight. Default value is "identity".

- **alpha_max**: Maximum weight the discount function can apply. Default is 1. For a two-arm trial, users may specify a vector of two values where the first value is used to weight the historical treatment group and the second value is used to weight the historical control group.

- **fix_alpha**: Fix alpha at alpha_max? Default value is FALSE.

- **weibull_scale**: Scale parameter of the Weibull discount function used to compute alpha, the weight parameter of the historical data. Default value is 0.135. For a two-arm trial, users may specify a vector of two values where the first value is used to estimate the weight of the historical treatment group and the second value is used to estimate the weight of the historical control group. Not used when discount_function = "identity".

- **weibull_shape**: Shape parameter of the Weibull discount function used to compute alpha, the weight parameter of the historical data. Default value is 3. For a two-arm trial, users may specify a vector of two values where the first value is used to estimate the weight of the historical treatment group and the second value is used to estimate the weight of the historical control group. Not used when discount_function = "identity".


**data_normal**: The data normal is a wrapper function for inputting data for analysis of bayesian trial with normal outcome. The **data_normal** takes three input (**treatment**, **outcome** and **complete**).

- **treatment**: treatment assignment for patients in the trial, 1 for treatment group and 0 for control group. 

- **outcome**: normal outcome of the trial. The length of the vector is the same size as the treatment variable. 

- **complete**: similar length as treatment and outcome variable, 1 for complete outcome, 0 for loss to follow up. If complete is 0, the outcome of the patient is ignored. If complete is not provided, the dataset is assumed to be complete.

**analysis**: The analysis is a wrapper function for analyzing of bayesian trial with normal outcome. The **analysis** takes the pipe function input and analyze the trial. 

- **input**: The input of the analysis is a list of input to run the adaptive trials. 

- **type**: The type input determines what trial to be analyzed. In the normal trials, the type needs to be set to "normal". 


**simulate**: The simulate is a wrapper function for simulation of adaptive trials. The **simulate** takes the pipe function input and runs the trial. 

- **input** - The input of the analysis is a list of input to run the adaptive trials. 

- **no_of_sim**- The no_of_sim determines the number of trials to be run. The default is set to 10,000. 

# Design

We will discuss the design of adaptive trial using bayesCT for normal outcome in the following section. 
We illustrate an example for one-arm trial and two-arm trial using the wrapper functions described above. 

## One-arm Trial

In the example below, we will illustrate how to compute power, type 1 error and other clinical trial details for an objective performace criterion (OPC) trial with proportion of events described as follows, 
$$H_0: \mu_{treatment} \geq 0.08 \qquad H_A:\theta_{treatment} < 0.08.$$

```{r}
value <-
  normal_outcome(mu_control = 16, mu_treatment = 13,
                 sd_treatment = 1.4, sd_control = 1.9) %>%
  study_details(total_sample_size = 300, study_period = 50,
                interim_look = c(210, 240, 270),
                prop_loss_to_followup = 0.10)

output <- value %>%
            simulate(no_of_sim = 10)

str(output)
```

```{r}
value <- value %>%
  enrollment_rate(lambda = c(0.3, 1), time = 25) 
  

output <- value %>%
            simulate(no_of_sim = 10)

str(output)
```

```{r}
value <- value %>%
  hypothesis(delta = 0, futility_prob = 0.05, prob_accept_ha = 0.95,
             expected_success_prob = 0.90, alternative = "less")
  

output <- value %>%
            simulate(no_of_sim = 10)

str(output)
```

```{r}
value <- value %>%
  impute(no_of_impute = 25, number_mcmc = 1000)
  

output <- value %>%
            simulate(no_of_sim = 10)

str(output)
```


```{r}
value <- value %>%
  randomize(block_size = 2, randomization_ratio = c(1, 1))
  

output <- value %>%
            simulate(no_of_sim = 10)

str(output)
```

```{r}
value <- value %>%
  historical_normal(mu0_treatment = 13, sd0_treatment = 2, N0_treatment = 100,
                    mu0_control = 12, sd0_control = 3, N0_control = 120, 
                    discount_function = "scaledweibull", alpha_max = F, fix_alpha = 1,
                    weibull_scale = 0.135, weibull_shape = 3)
  

output <- value %>%
            simulate(no_of_sim = 10)

str(output)
```


```{r}
value <-
  normal_outcome(mu_control = 16, mu_treatment = 13,
                 sd_treatment = 1.4, sd_control = 1.9) %>%
  enrollment_rate(lambda = c(0.3, 1), time = 25) %>%
  study_details(total_sample_size = 300, study_period = 50,
                interim_look = c(210, 240, 270),
                prop_loss_to_followup = 0.10) %>%
  impute(no_of_impute = 25, number_mcmc = 1000) %>%
  randomize(block_size = 2, randomization_ratio = c(1, 1)) %>%
  hypothesis(delta = 0, futility_prob = 0.05, prob_accept_ha = 0.95,
             expected_success_prob = 0.90, alternative = "less") %>%
  historical_normal(mu0_treatment = 13, sd0_treatment = 2, N0_treatment = 100,
                    mu0_control = 12, sd0_control = 3, N0_control = 120, 
                    discount_function = "weibull", alpha_max = F, fix_alpha = 1,
                    weibull_scale = 0.135, weibull_shape = 3) %>%
  simulate(no_of_sim = 5)


str(value)
```

# Analysis

In this section, we will demonstrate how to run adaptive bayesian trial using **bayesCT**. 
A sample dataset is provided in the package. 
The dataset 

```{r}
data(normaldata)

head(normaldata)
```



```{r}
value1 <-
  data_normal(treatment = normaldata$treatment, 
              outcome   = normaldata$outcome, 
              complete  = normaldata$complete) %>%
  analysis(type = "normal")

str(value1)
```


```{r}
value1 <-
  data_normal(treatment = normaldata$treatment, 
              outcome   = normaldata$outcome, 
              complete  = normaldata$complete) %>%
  hypothesis(delta = 0, futility_prob = 0.05, prob_accept_ha = 0.95,
             expected_success_prob = 0.90, alternative = "less") %>%
  analysis(type = "normal")

str(value1)
  
```


```{r}
value1 <-
  data_normal(treatment = normaldata$treatment, 
              outcome   = normaldata$outcome, 
              complete  = normaldata$complete) %>%
  hypothesis(delta = 0, futility_prob = 0.05, prob_accept_ha = 0.95,
             expected_success_prob = 0.90, alternative = "less") %>%
  impute(no_of_impute = 25, number_mcmc = 1000) %>%
  analysis(type = "normal")

str(value1)
```


```{r}

value1 <-
  data_normal(treatment = normaldata$treatment, 
              outcome   = normaldata$outcome, 
              complete  = normaldata$complete) %>%
  hypothesis(delta = 0, futility_prob = 0.05, prob_accept_ha = 0.95,
             expected_success_prob = 0.90, alternative = "less") %>%
  impute(no_of_impute = 25, number_mcmc = 1000) %>%
  historical_normal(mu0_treatment = 13, sd0_treatment = 2, N0_treatment = 100,
                    mu0_control = 12, sd0_control = 3, N0_control = 120, 
                    discount_function = "weibull", alpha_max = F, fix_alpha = 1,
                    weibull_scale = 0.135, weibull_shape = 3) %>%
  analysis(type = "normal")


str(value1)
```

